<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=1200" />
<title>2Pick 模倣サイト</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#141a22; --panel2:#1b2330; --accent:#2eaadf; --text:#e8f0fb;
    --muted:#9bb0c6; --gold:#d9a441; --legend:#a25bff; --silver:#bfc9d6; --bronze:#cd9964;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0f14,#101821 60%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Meiryo',sans-serif;}
  header{padding:18px 22px;border-bottom:1px solid #243041;background:#0f1620;position:sticky;top:0;z-index:50}
  header h1{margin:0;font-size:20px;letter-spacing:.5px}
  main{max-width:1200px;margin:24px auto;padding:0 16px 40px}
  .grid{display:grid;gap:18px}
  .grid.cols-4{grid-template-columns:repeat(4,1fr)}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .panel{background:linear-gradient(180deg,var(--panel),#0e1520);border:1px solid #26364b;border-radius:16px;padding:16px}
  .title{font-size:18px;font-weight:800;margin:0 0 12px;letter-spacing:.5px}
  .sub{color:var(--muted);font-size:13px;margin-top:-6px;margin-bottom:10px}
  .class-pill{display:inline-block;padding:3px 10px;border:1px solid #2f455e;border-radius:999px;font-size:12px;color:#c9d7e8;margin-left:8px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;background:linear-gradient(180deg,#1e2b3d,#1a2533);border:1px solid #2b3b53;border-radius:12px;color:#eaf4ff;font-weight:700;cursor:pointer;user-select:none}
  .btn:hover{filter:brightness(1.06)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .footerbar{display:flex;align-items:center;justify-content:space-between;margin-top:14px}
  .flex{display:flex;gap:12px;align-items:center}

  /* ===== カード ===== */
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #2a394b;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden;display:flex;flex-direction:column;min-height:260px}
  .card .thumb{position:relative;height:220px;background:#0e141c;display:flex;align-items:center;justify-content:center}
  .card .thumb img{max-height:100%;max-width:100%;object-fit:contain;display:block;filter:drop-shadow(0 6px 16px rgba(0,0,0,.6))}
  .badge{position:absolute;left:10px;top:10px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;background:#223040;border:1px solid #2f455e;color:var(--muted)}
  .badge.legend{background:rgba(162,91,255,.18);border-color:#7b55f7;color:#cbb5ff}
  .badge.gold{background:rgba(217,164,65,.15);border-color:#d9a441;color:#ffd88d}
  .badge.silver{background:rgba(191,201,214,.12);border-color:#bfc9d6;color:#e6edf5}
  .badge.bronze{background:rgba(205,153,100,.12);border-color:#cd9964;color:#f1d6bf}
  .body{padding:12px 14px 14px}
  .name{font-size:15px;font-weight:700;line-height:1.35;margin-bottom:6px}
  .effect{font-size:13px;color:var(--muted);line-height:1.5;max-height:5.5em;overflow:auto;white-space:pre-wrap}
  .detail-link{margin-top:8px;display:block;font-size:12px;color:#78c6f3;text-decoration:none;word-break:break-all}
  .detail-link:hover{text-decoration:underline}

  /* ミニカード（デッキサマリー） */
  .deck{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;max-height:420px;overflow:auto;padding-right:2px}
  .mini{border:1px solid #2b3b53;border-radius:10px;padding:6px;background:#0f1520}
  .mini img{width:100%;height:96px;object-fit:cover;border-radius:6px}
  .mini .t{font-size:11px;margin-top:4px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .legendary{color:#cbb5ff}.goldy{color:#ffd88d}.silvery{color:#e6edf5}.bronzy{color:#f1d6bf}

  /* モーダル */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100}
  .modal.show{display:flex}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.65)}
  .modal-card{position:relative;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #2a394b;border-radius:16px;max-width:1100px;width:92vw;max-height:86vh;box-shadow:0 10px 30px rgba(0,0,0,.45);padding:16px;overflow:hidden}
  .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .closebtn{cursor:pointer;border:1px solid #2b3b53;border-radius:10px;padding:6px 10px;background:#142031;color:#eaf4ff;font-weight:700}
  .modal-body{overflow:auto}
  .modal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
  .modal-card .mini img{height:140px}
  .modal-card .mini .t{font-size:12px}
</style>
</head>
<body>
<header><h1>2Pick 模倣サイト <span id="phaseLabel" style="font-weight:600;color:#9bb0c6"></span></h1></header>
<main id="app">
  <div id="loading" class="panel"><div class="title">読み込み中…</div><div class="sub">cards.json を読み込んでいます</div></div>
</main>

<!-- Deck Modal -->
<div id="deckModal" class="modal" aria-hidden="true">
  <div class="backdrop" onclick="closeDeckModal()"></div>
  <div class="modal-card">
    <div class="modal-head">
      <div class="title" style="margin:0">選択済みデッキ</div>
      <button class="closebtn" onclick="closeDeckModal()">閉じる</button>
    </div>
    <div id="deckModalBody" class="modal-body">
      <div class="modal-grid" id="deckModalGrid"></div>
    </div>
  </div>
</div>

<script>
/* ====== ユーティリティ ====== */
const CLASSES = ['エルフ','ロイヤル','ウィッチ','ドラゴン','ナイトメア','ビショップ','ネメシス']; // ニュートラルは初期提示に含めない
const ALL_CLASSES = ['ニュートラル',...CLASSES];
const RARITIES = ['ブロンズ','シルバー','ゴールド','レジェンド'];
const rarityClass = r => ({'レジェンド':'legend','ゴールド':'gold','シルバー':'silver','ブロンズ':'bronze'}[r]||'');
const $ = sel => document.querySelector(sel);
const app = $('#app'), phaseLabel = $('#phaseLabel');

/* ====== 状態 ====== */
let CARDS = [];                 // 全カード
let POOLS = {};                 // クラス別プール + ニュートラル
let INITIAL_PAIRS = {};         // クラスごとの初期2枚（LL or LG）
let state = {
  phase: 'class',               // 'class' | 'pick'
  selectedClass: null,
  deck: [],
  pickIndex: 1,
  rerollsLeft: 2,
};

/* ====== ピック設定 ====== */
const PICK_SCHEDULE = {
  // 1〜19回の提示レア（B/S交互、6/12/18はG、19は以前の仕様に戻します）
  1:'ブロンズ',2:'シルバー',3:'ブロンズ',4:'シルバー',5:'ブロンズ',6:'ゴールド',
  7:'ブロンズ',8:'シルバー',9:'ブロンズ',10:'シルバー',11:'ブロンズ',12:'ゴールド',
  13:'ブロンズ',14:'シルバー',15:'ブロンズ',16:'シルバー',17:'ブロンズ',18:'ゴールド',
  19:'シルバー'
};
const NEUTRAL_RATE = 0.15;      // ニュートラル混入率（低め）
const getRand = n => Math.floor(Math.random()*n);
const choice = arr => arr[getRand(arr.length)];
const shuffle = arr => arr.sort(()=>Math.random()-0.5);

/* ——— 低確率“上振れ”ロジック（再抽選時のみ） ——— */
function maybeUpgrade(rarity){
  const roll = Math.random();
  if (rarity==='ブロンズ') return (roll<0.20)?'シルバー':'ブロンズ';
  if (rarity==='シルバー') return (roll<0.20)?'ゴールド':'シルバー';
  if (rarity==='ゴールド') return (roll<0.10)?'レジェンド':'ゴールド';
  return rarity;
}

/* ====== データ読み込み ====== */
async function load(){
  const res = await fetch('cards.json');
  CARDS = await res.json();

  // クラス別プールを構築
  POOLS['ニュートラル'] = CARDS.filter(c=>c.class==='ニュートラル');
  for(const cls of CLASSES){ POOLS[cls] = CARDS.filter(c=>c.class===cls); }
}

/* ====== 初期提示：各クラスに LL or LG の2枚セット（デッキに加算） ====== */
function makeInitialPair(cls){
  const poolL = POOLS[cls].filter(c=>c.rarity==='レジェンド');
  const poolG = POOLS[cls].filter(c=>c.rarity==='ゴールド');
  const pattern = Math.random()<0.5 ? 'LL' : 'LG';
  const a = choice(poolL);
  const b = (pattern==='LL') ? choice(poolL.filter(x=>x!==a)) : choice(poolG);
  return [a,b];
}

/* ====== ピック用：指定レアの2枚組 ====== */
function pickTwoOfRarity(cls, rarity){
  let pool = POOLS[cls].filter(c=>c.rarity===rarity);
  if (Math.random() < NEUTRAL_RATE) {
    const add = POOLS['ニュートラル'].filter(c=>c.rarity===rarity);
    pool = pool.concat(add);
  }
  pool = shuffle([...new Set(pool)]);
  const a = pool[0];
  const b = pool.find(x=>x!==a) || pool[1] || a;
  return [a,b].filter(Boolean);
}
  pool = shuffle([...new Set(pool)]);
  if (pool.length===0){
    // どうしても枯渇した場合は、上位/下位レアから救済（同じく3枚制限を守る）
    const altR = rarity==='ブロンズ'?'シルバー':rarity==='シルバー'?'ゴールド':'レジェンド';
    pool = shuffle((POOLS[cls].concat(POOLS['ニュートラル'])).filter(c=>c.rarity===altR && canAdd(c,1)));
  }
  const a = pool[0];
  // 2枚目は、同一カードなら +2 で上限を超えないかチェック
  let b = pool.find(x=>x!==a && canAdd(x,1));
  if (!b){
    if (a && canAdd(a,2)) b = a; // 同じカードを2枚提示しても上限OKなら採用
    else b = pool[1];
  }
  return [a,b].filter(Boolean);
}

/* ====== UI描画 ====== */
function badgeHTML(r){ return `<span class="badge ${rarityClass(r)}">${r}</span>`; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
function cardHTML(c){
  const detail = c.detailUrl ? `<a class="detail-link" href="${c.detailUrl}" target="_blank" rel="noopener">${c.detailUrl}</a>` : '';
  return `
  <div class="card">
    <div class="thumb">
      <img src="${c.img}" alt="${escapeHtml(c.name)}">
      ${badgeHTML(c.rarity)}
    </div>
    <div class="body">
      <div class="name">${escapeHtml(c.name)}</div>
      <div class="effect">${c.effect ? escapeHtml(c.effect) : '（効果テキスト未登録）'}</div>
      ${detail}
    </div>
  </div>`;
}
function pairHTML(a,b){ return `<div class="grid cols-2">${cardHTML(a)}${cardHTML(b)}</div>`; }

function renderClassSelect(){
  state.phase = 'class';
  phaseLabel.textContent = '— クラス選択（初期提示：LL または LG を先にデッキへ）';
  INITIAL_PAIRS = {};
  const grids = CLASSES.map(cls=>{
    const [a,b] = makeInitialPair(cls);
    INITIAL_PAIRS[cls] = [a,b];
    return `
      <div class="panel">
        <div class="title">${cls} <span class="class-pill">最初にこの2枚が配られます</span></div>
        ${pairHTML(a,b)}
        <div class="footerbar">
          <div class="hint">※ ニュートラルは初期提示に含めません</div>
          <button class="btn" onclick="startPick('${cls}')">このクラスで開始</button>
        </div>
      </div>`;
  }).join('');
  app.innerHTML = `<div class="grid cols-2" style="grid-template-columns:repeat(2,1fr);gap:18px">${grids}</div>`;
}

const PICK_SCHEDULE_MAP = PICK_SCHEDULE; // 1..19
function rarityForPick(i, forReroll=false){
  const base = PICK_SCHEDULE_MAP[i];
  return forReroll ? maybeUpgrade(base) : base;
}
function makeTwoOptions(cls, i, forReroll=false){
  const r = rarityForPick(i, forReroll);
  const left = pickTwoOfRarity(cls, r);
  const right = pickTwoOfRarity(cls, r);
  return [left,right];
}

let currentOptions = null; // [[a,b],[c,d]]

function groupDeck(cards){
  const map = new Map();
  for (const c of cards){
    const key = `${c.name}||${c.rarity}`; // 同名同レアでまとめる
    if (!map.has(key)) map.set(key, {card:c, count:0});
    map.get(key).count++;
  }
  const arr = Array.from(map.values());
  // 可能なら cost で並べ替え（cards.jsonにcostがあれば使う）。無ければ名前順。
  arr.sort((a,b)=>{
    const ac = Number(a.card.cost ?? NaN), bc = Number(b.card.cost ?? NaN);
    const aHas = !Number.isNaN(ac), bHas = !Number.isNaN(bc);
    if (aHas && bHas && ac!==bc) return ac-bc;
    if (aHas && !bHas) return -1;
    if (!aHas && bHas) return 1;
    return a.card.name.localeCompare(b.card.name, 'ja');
  });
  return arr;
}

function renderPick(){
  state.phase = 'pick';
  phaseLabel.textContent = `— 2Pick中：${state.selectedClass} / ${state.pickIndex} / 19`;
  const i = state.pickIndex;

  if (!currentOptions) currentOptions = makeTwoOptions(state.selectedClass, i, false);
  const [L,R] = currentOptions;

  const rLabel = `提示レア：${PICK_SCHEDULE_MAP[i]}`;
  const deckCount = state.deck.length;

  app.innerHTML = `
  <div class="grid cols-3" style="grid-template-columns:1fr 430px 1fr">
    <div class="panel">
      <div class="title">選択肢 A</div>
      ${pairHTML(L[0],L[1])}
      <div class="footerbar">
        <div class="hint">${rLabel}</div>
        <button class="btn" onclick="choosePair(0)">A を選ぶ</button>
      </div>
    </div>

    <div class="panel">
      <div class="title">現在の状況</div>
      <div class="sub">クラス：<b>${state.selectedClass}</b>　/　ピック：<b>${i} / 19</b></div>
      <div class="sub">所持カード：<b>${deckCount}</b>枚（初期2枚 + A/Bから各2枚）</div>
      <div class="sub">再抽選 残り：<b>${state.rerollsLeft}</b> 回</div>
      <div class="footerbar">
        <button class="btn" onclick="doReroll()" ${state.rerollsLeft<=0 ? 'disabled':''}>カード再抽選</button>
        <div class="hint">※再抽選時は少しだけ上位レアが出やすくなります</div>
        </div>
      </div>
      </div>
      <hr style="border:0;border-top:1px solid #2b3b53;margin:14px 0">
      <div class="title" style="font-size:16px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between">デッキ
        <button class="btn" style="padding:6px 10px;font-size:12px" onclick="openDeckModal()">拡大表示</button>
      </div>
      <div class="deck" id="deckView"></div>
    </div>

    <div class="panel">
      <div class="title">選択肢 B</div>
      ${pairHTML(R[0],R[1])}
      <div class="footerbar">
        <div class="hint">${rLabel}</div>
        <button class="btn" onclick="choosePair(1)">B を選ぶ</button>
      </div>
    </div>
  </div>
  `;

  renderDeckMini();
}

function renderDeckMini(){
  const wrap = $('#deckView');
  const grouped = groupDeck(state.deck);
  wrap.innerHTML = grouped.map(({card, count})=>`
    <div class="mini">
      <img src="${card.img}" alt="${card.name}">
      <div class="t ${card.rarity==='レジェンド'?'legendary':card.rarity==='ゴールド'?'goldy':card.rarity==='シルバー'?'silvery':'bronzy'}">${card.rarity}・${card.name}${count>1?` ×${count}`:''}</div>
    </div>
  `).join('');
}

function openDeckModal(){ renderDeckModal(); $('#deckModal').classList.add('show'); }
function closeDeckModal(){ $('#deckModal').classList.remove('show'); }
function renderDeckModal(){
  const grid = $('#deckModalGrid');
  const grouped = groupDeck(state.deck);
  grid.innerHTML = grouped.map(({card, count})=>`
    <div class="mini">
      <img src="${card.img}" alt="${card.name}">
      <div class="t ${card.rarity==='レジェンド'?'legendary':card.rarity==='ゴールド'?'goldy':card.rarity==='シルバー'?'silvery':'bronzy'}">${card.rarity}・${card.name}${count>1?` ×${count}`:''}</div>
    </div>
  `).join('');
}

/* ====== イベント ====== */
function startPick(cls){
  state.selectedClass = cls;
  state.deck = [...(INITIAL_PAIRS[cls]||[])]; // 初期2枚をデッキへ
  state.pickIndex = 1;
  state.rerollsLeft = 2;
  currentOptions = null;
  renderPick();
}

function choosePair(which){
  const [L,R] = currentOptions;
  const chosen = (which===0)? L : R;
  state.deck.push(...chosen);
  state.pickIndex++;
  currentOptions = null;

  if (state.pickIndex>19){
    renderResult();
  }else{
    renderPick();
  }
}
      else if (canAdd(card,1)) { state.deck.push(card); }
    } else {
      if (canAdd(card,1)) state.deck.push(card);
    }
  }
  state.pickIndex++;
  currentOptions = null;

  if (state.pickIndex>19){
    renderResult();
  }else{
    renderPick();
  }
}else{
    renderPick();
  }
}

function doReroll(){
  if (state.rerollsLeft<=0) return;
  state.rerollsLeft--;
  currentOptions = makeTwoOptions(state.selectedClass, state.pickIndex, true);
  renderPick();
}

function renderResult(){
  phaseLabel.textContent = '— 完了';
  const grouped = groupDeck(state.deck);
  app.innerHTML = `
    <div class="panel">
      <div class="title">ドラフト完了！</div>
      <div class="sub">クラス：<b>${state.selectedClass}</b>　/　総枚数：<b>${state.deck.length}</b>（上限3枚/カード）</div>
      <div class="deck" style="grid-template-columns:repeat(8,1fr)">${grouped.map(({card,count})=>`
        <div class="mini"><img src="${card.img}" alt="${card.name}"><div class="t">${card.rarity}・${card.name}${count>1?` ×${count}`:''}</div></div>
      `).join('')}</div>
      <div class="footerbar" style="margin-top:16px">
        <button class="btn" onclick="renderClassSelect()">最初に戻る</button>
        <div class="hint">もう一度ピックしたい場合は「最初に戻る」を押してください</div>
      </div>
    </div>
  `;
}</b>　/　総枚数：<b>${state.deck.length}</b></div>
      <div class="deck" style="grid-template-columns:repeat(8,1fr)">${grouped.map(({card,count})=>`
        <div class="mini"><img src="${card.img}" alt="${card.name}"><div class="t">${card.rarity}・${card.name}${count>1?` ×${count}`:''}</div></div>
      `).join('')}</div>
      <div class="footerbar" style="margin-top:16px">
        <button class="btn" onclick="renderClassSelect()">最初に戻る</button>
        <div class="hint">もう一度ピックしたい場合は「最初に戻る」を押してください</div>
      </div>
    </div>
  `;
}

/* ====== 起動 ====== */
(async ()=>{ await load(); renderClassSelect(); })();
</script>
</body>
</html>
